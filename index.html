// script.js
let parsedData = [];
let headers = [];

function previewData() {
  const file = document.getElementById('fileInput').files[0];
  if (!file) return alert("Please upload a file");

  const reader = new FileReader();
  reader.onload = function (e) {
    const csv = e.target.result;
    parsedData = csv.split('\n').map(row => row.split(','));
    headers = parsedData[0];

    const previewContainer = document.getElementById('previewContainer');
    const table = document.createElement('table');

    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    headers.forEach((header, i) => {
      const th = document.createElement('th');
      th.textContent = `Col ${i+1}`;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    parsedData.slice(1, 6).forEach(row => {
      const tr = document.createElement('tr');
      row.forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    previewContainer.innerHTML = '';
    previewContainer.appendChild(table);

    document.getElementById('rangeSelectors').style.display = 'block';
  };
  reader.readAsText(file);
}

function parseRange(rangeText) {
  if (rangeText.includes(':')) {
    let [start, end] = rangeText.split(':');
    start = parseInt(start) - 1;
    end = end === 'n' ? parsedData[0].length - 1 : parseInt(end) - 1;
    return Array.from({length: end - start + 1}, (_, i) => start + i);
  }
  return [];
}

let processedData = [];

function processData() {
  const fixedCols = parseRange(document.getElementById('fixedRange').value);
  const tripletCols = parseRange(document.getElementById('tripletRange').value);
  if (fixedCols.length === 0 || tripletCols.length === 0) return alert("Invalid ranges");

  processedData = [];
  const fixedHeaders = fixedCols.map(i => headers[i]);

  for (let r = 1; r < parsedData.length; r++) {
    const row = parsedData[r];
    const fixedPart = fixedCols.map(i => row[i]);

    for (let i = 0; i < tripletCols.length; i += 3) {
      const brand = row[tripletCols[i]] || "";
      const subCat = row[tripletCols[i+1]] || "";
      const sku = row[tripletCols[i+2]] || "";

      const category = /Atta|Maida|Semolina/.test(subCat) ? 'Flour' :
                       subCat === 'Lentil' ? 'Lentil' :
                       subCat === 'Mustard Oil' ? 'Mustard Oil' :
                       subCat === 'Puffed Rice' ? 'Puffed Rice' :
                       /Rice Chinigura|Rice Others/.test(subCat) ? 'Rice' :
                       subCat === 'Salt' ? 'Salt' : '';

      if (brand || subCat || sku) {
        processedData.push([...fixedPart, brand, category, subCat, sku]);
      }
    }
  }

  document.getElementById('downloadBtn').style.display = 'inline-block';
  alert("Data processed. Click Download.");
}

function downloadExcel() {
  const wb = XLSX.utils.book_new();
  const wsData = [
    ...[headers.slice(0, 9), 'Brand', 'Category', 'Sub Category', 'SKU'],
    ...processedData
  ];
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Processed Data");
  XLSX.writeFile(wb, "processed_data.xlsx");
}
